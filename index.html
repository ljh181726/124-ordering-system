<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <title>å­¸é¤ç³»çµ±</title>
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Firebase v11 æ¨¡çµ„åŒ– -->
  <script type="module">
    // å¾å®˜æ–¹ CDN è¼‰å…¥éœ€è¦çš„ Firebase å¥—ä»¶
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
    import { 
      getFirestore, doc, setDoc, getDoc, updateDoc, arrayUnion, arrayRemove, 
      onSnapshot, collection, getDocs, serverTimestamp 
    } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

    // âœ… Firebase å°ˆæ¡ˆè¨­å®š
    const firebaseConfig = {
      apiKey: "AIzaSyCXrInE1Fg1k1pMvIdTOQtXsnJbi-T1ROw",
      authDomain: "school-lunch-649ef.firebaseapp.com",
      projectId: "school-lunch-649ef",
      storageBucket: "school-lunch-649ef.appspot.com",
      messagingSenderId: "533107630740",
      appId: "1:533107630740:web:aaa3900ea4af2cb4a3949a"
    };

    // åˆå§‹åŒ– Firebase
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // âœ… å…¨åŸŸè®Šæ•¸
    const ADMIN_PASSWORD = "1234"; // ç®¡ç†å“¡å¯†ç¢¼
    let weeklyMenuData = {};       // æš«å­˜æ¯é€±èœå–®
    let todayOrders = {};          // æš«å­˜ä»Šæ—¥è¨‚å–®

    // ==============================
    // ğŸš€ ç™»å…¥ Firebase (åŒ¿åç™»å…¥)
    // ==============================
    signInAnonymously(auth)
      .then(() => console.log("åŒ¿åç™»å…¥æˆåŠŸ"))
      .catch(err => console.error("ç™»å…¥å¤±æ•—", err));

    // ==============================
    // ğŸš€ ç•«é¢å€å¡Šåˆ‡æ›
    // ==============================
    function toggleArea(id) {
      document.querySelectorAll(".area").forEach(area => area.classList.add("hidden"));
      document.getElementById(id).classList.remove("hidden");
    }
    window.toggleArea = toggleArea;

    // ==============================
    // ğŸš€ è¨Šæ¯å½ˆçª— (Modal)
    // ==============================
    function showMessage(msg) {
      document.getElementById("messageText").innerText = msg;
      document.getElementById("messageBox").classList.remove("hidden");
    }
    window.showMessage = showMessage;

    document.getElementById("closeMessageBtn").addEventListener("click", () => {
      document.getElementById("messageBox").classList.add("hidden");
    });

    // ==============================
    // ğŸš€ å»ºç«‹ä¸€é€± (day1~day5) åˆå§‹æ–‡ä»¶
    // ==============================
    async function populateInitialDayDocs() {
      for (let d = 1; d <= 5; d++) {
        const ref = doc(db, "public_weekly_menu", `day${d}`);
        const snap = await getDoc(ref);
        if (!snap.exists()) {
          await setDoc(ref, { 
            restaurant: "", 
            items: [] 
          });
          console.log(`å»ºç«‹åˆå§‹ doc: day${d}`);
        }
      }
    }

    // ==============================
    // ğŸš€ åˆå§‹åŒ–ç›£è½èœå–® (æ¯ä¸€å¤©)
    // ==============================
    function initializeMenuListener() {
      for (let d = 1; d <= 5; d++) {
        const ref = doc(db, "public_weekly_menu", `day${d}`);
        onSnapshot(ref, snapshot => {
          if (snapshot.exists()) {
            weeklyMenuData[d] = snapshot.data();
            renderMenuEditor();
            renderTodayMenu();
          }
        });
      }
    }

    // ==============================
    // ğŸš€ ç®¡ç†å“¡ï¼šæ¸²æŸ“æ¯é€±èœå–®ç·¨è¼¯å™¨
    // ==============================
    function renderMenuEditor() {
      const container = document.getElementById("menuEditorArea");
      container.innerHTML = "";
      for (let d = 1; d <= 5; d++) {
        const data = weeklyMenuData[d] || { restaurant: "", items: [] };
        let html = `
          <div class="border p-3 my-2 rounded bg-white shadow">
            <h3 class="font-bold">æ˜ŸæœŸ${d}</h3>
            <label>é¤å»³åç¨±ï¼š
              <input class="border p-1" id="restaurant_day${d}" value="${data.restaurant}">
            </label>
            <button class="bg-blue-500 text-white px-2 py-1 rounded ml-2" onclick="updateRestaurantName(${d})">æ›´æ–°</button>
            <ul class="mt-2">
        `;
        data.items.forEach((item, i) => {
          html += `<li>${item.name} $${item.price}
            <button class="text-red-500" onclick="removeFood(${d}, ${i})">åˆªé™¤</button>
          </li>`;
        });
        html += `</ul>
          <div class="mt-2">
            <input class="border p-1" placeholder="å“é …" id="item_day${d}">
            <input class="border p-1" type="number" placeholder="åƒ¹æ ¼" id="price_day${d}">
            <button class="bg-green-500 text-white px-2 py-1 rounded" onclick="addFood(${d})">æ–°å¢</button>
          </div>
        </div>`;
        container.innerHTML += html;
      }
    }
    window.updateRestaurantName = async function(day) {
      const ref = doc(db, "public_weekly_menu", `day${day}`);
      const name = document.getElementById(`restaurant_day${day}`).value.trim();
      await updateDoc(ref, { restaurant: name });
      showMessage(`æ˜ŸæœŸ${day} é¤å»³æ›´æ–°æˆåŠŸ`);
    };
    window.addFood = async function(day) {
      const ref = doc(db, "public_weekly_menu", `day${day}`);
      const name = document.getElementById(`item_day${day}`).value.trim();
      const price = parseInt(document.getElementById(`price_day${day}`).value);
      if (!name || isNaN(price)) return showMessage("è«‹è¼¸å…¥å“é …èˆ‡åƒ¹æ ¼");
      await updateDoc(ref, { items: arrayUnion({ name, price }) });
      showMessage(`æ–°å¢æˆåŠŸ: ${name} $${price}`);
    };
    window.removeFood = async function(day, index) {
      const item = weeklyMenuData[day].items[index];
      const ref = doc(db, "public_weekly_menu", `day${day}`);
      await updateDoc(ref, { items: arrayRemove(item) });
      showMessage(`åˆªé™¤ ${item.name}`);
    };

    // ==============================
    // ğŸš€ å­¸ç”Ÿï¼šä»Šæ—¥èœå–® + ä¸‹å–®
    // ==============================
    function renderTodayMenu() {
      const today = new Date().getDay(); // 0=é€±æ—¥, 1=é€±ä¸€...
      if (today < 1 || today > 5) {
        document.getElementById("todayMenuArea").innerHTML = "<p>ä»Šå¤©æ²’æœ‰ä¾›é¤ï¼</p>";
        return;
      }
      const data = weeklyMenuData[today] || { restaurant: "", items: [] };
      let html = `<h3 class="font-bold">ä»Šæ—¥é¤å»³ï¼š${data.restaurant || "æœªè¨­å®š"}</h3>
        <label>åº§è™Ÿï¼š<input id="seatNumberInput" class="border p-1 w-20"></label>
        <div>`;
      data.items.forEach((item, i) => {
        html += `
          <label>
            <input type="checkbox" id="item_${i}"> ${item.name} $${item.price}
            <input type="number" id="qty_${i}" class="border w-16" min="1" value="1">
          </label><br>`;
      });
      html += `</div>
        <button class="bg-green-500 text-white px-2 py-1 rounded mt-2" onclick="submitTodayOrder(${today})">é€å‡ºè¨‚å–®</button>`;
      document.getElementById("todayMenuArea").innerHTML = html;
    }
    window.submitTodayOrder = async function(day) {
      const seat = document.getElementById("seatNumberInput").value.trim();
      if (!seat) return showMessage("è«‹è¼¸å…¥åº§è™Ÿï¼");
      const data = weeklyMenuData[day];
      let items = [];
      let total = 0;
      data.items.forEach((item, i) => {
        if (document.getElementById(`item_${i}`).checked) {
          const qty = parseInt(document.getElementById(`qty_${i}`).value) || 1;
          items.push({ name: item.name, price: item.price, qty });
          total += item.price * qty;
        }
      });
      if (items.length === 0) return showMessage("è«‹è‡³å°‘é¸ä¸€é …é¤é»");
      const order = { seat, items, total, time: serverTimestamp() };
      const ref = doc(db, "public_daily_orders", new Date().toISOString().slice(0,10));
      const snap = await getDoc(ref);
      let dataObj = snap.exists() ? snap.data() : { orders: {} };
      dataObj.orders[seat] = order;
      await setDoc(ref, dataObj);
      showMessage("è¨‚å–®é€å‡ºæˆåŠŸï¼");
    };

    // ==============================
    // ğŸš€ ç®¡ç†å“¡ï¼šç›£è½ä»Šæ—¥è¨‚å–®
    // ==============================
    function initializeOrderListener() {
      const ref = doc(db, "public_daily_orders", new Date().toISOString().slice(0,10));
      onSnapshot(ref, snapshot => {
        if (snapshot.exists()) {
          todayOrders = snapshot.data().orders;
          renderOrderList();
        }
      });
    }
    function renderOrderList() {
      const container = document.getElementById("orderList");
      container.innerHTML = "";
      let total = 0, count = 0;
      Object.values(todayOrders).forEach(order => {
        container.innerHTML += `<p>åº§è™Ÿ${order.seat}: ${order.items.map(i=>`${i.name}x${i.qty}`).join(", ")} = $${order.total}</p>`;
        total += order.total;
        count++;
      });
      container.innerHTML += `<p class="font-bold">ç¸½é‡‘é¡ï¼š$${total} å¹³å‡ï¼š$${(total/count||0).toFixed(1)}</p>`;
    }

    // ==============================
    // ğŸš€ ç®¡ç†å“¡ç™»å…¥æª¢æŸ¥
    // ==============================
    window.checkAdminPassword = function() {
      const input = document.getElementById("adminPassword").value;
      if (input === ADMIN_PASSWORD) {
        showMessage("ç™»å…¥æˆåŠŸï¼");
        toggleArea("adminMenu");
      } else {
        showMessage("å¯†ç¢¼éŒ¯èª¤ï¼");
      }
    };

    // ==============================
    // ğŸš€ åˆå§‹åŒ–
    // ==============================
    window.onload = async () => {
      await populateInitialDayDocs();
      initializeMenuListener();
      initializeOrderListener();
      renderTodayMenu();
    };
  </script>
</head>
<body class="bg-gray-100">
  <div class="p-4">
    <h1 class="text-2xl font-bold">å­¸é¤ç³»çµ±</h1>
    <button onclick="toggleArea('studentMenu')" class="bg-green-500 text-white px-2 py-1 m-1 rounded">å­¸ç”Ÿè¨‚é¤</button>
    <button onclick="toggleArea('adminLogin')" class="bg-blue-500 text-white px-2 py-1 m-1 rounded">ç®¡ç†å“¡</button>
  </div>

  <!-- å­¸ç”Ÿè¨‚é¤å€ -->
  <div id="studentMenu" class="area hidden p-4">
    <h2 class="text-xl font-bold mb-2">ä»Šæ—¥èœå–®</h2>
    <div id="todayMenuArea"></div>
  </div>

  <!-- ç®¡ç†å“¡ç™»å…¥ -->
  <div id="adminLogin" class="area hidden p-4">
    <h2 class="text-xl font-bold mb-2">ç®¡ç†å“¡ç™»å…¥</h2>
    <input type="password" id="adminPassword" class="border p-1">
    <button onclick="checkAdminPassword()" class="bg-blue-500 text-white px-2 py-1 rounded">ç™»å…¥</button>
  </div>

  <!-- ç®¡ç†å“¡å¾Œå° -->
  <div id="adminMenu" class="area hidden p-4">
    <h2 class="text-xl font-bold mb-2">å¾Œå°ç®¡ç†</h2>
    <h3 class="font-bold">èœå–®ç·¨è¼¯</h3>
    <div id="menuEditorArea"></div>
    <h3 class="font-bold mt-4">ä»Šæ—¥è¨‚å–®</h3>
    <div id="orderList"></div>
  </div>

  <!-- è¨Šæ¯ Modal -->
  <div id="messageBox" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center">
    <div class="bg-white p-4 rounded shadow">
      <p id="messageText"></p>
      <button id="closeMessageBtn" class="mt-2 bg-gray-500 text-white px-2 py-1 rounded">é—œé–‰</button>
    </div>
  </div>
</body>
</html>
