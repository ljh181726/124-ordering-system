<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <title>學餐系統</title>
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Firebase v11 模組化 -->
  <script type="module">
    // 從官方 CDN 載入需要的 Firebase 套件
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
    import { 
      getFirestore, doc, setDoc, getDoc, updateDoc, arrayUnion, arrayRemove, 
      onSnapshot, collection, getDocs, serverTimestamp 
    } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

    // ✅ Firebase 專案設定
    const firebaseConfig = {
      apiKey: "AIzaSyCXrInE1Fg1k1pMvIdTOQtXsnJbi-T1ROw",
      authDomain: "school-lunch-649ef.firebaseapp.com",
      projectId: "school-lunch-649ef",
      storageBucket: "school-lunch-649ef.appspot.com",
      messagingSenderId: "533107630740",
      appId: "1:533107630740:web:aaa3900ea4af2cb4a3949a"
    };

    // 初始化 Firebase
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // ✅ 全域變數
    const ADMIN_PASSWORD = "1234"; // 管理員密碼
    let weeklyMenuData = {};       // 暫存每週菜單
    let todayOrders = {};          // 暫存今日訂單

    // ==============================
    // 🚀 登入 Firebase (匿名登入)
    // ==============================
    signInAnonymously(auth)
      .then(() => console.log("匿名登入成功"))
      .catch(err => console.error("登入失敗", err));

    // ==============================
    // 🚀 畫面區塊切換
    // ==============================
    function toggleArea(id) {
      document.querySelectorAll(".area").forEach(area => area.classList.add("hidden"));
      document.getElementById(id).classList.remove("hidden");
    }
    window.toggleArea = toggleArea;

    // ==============================
    // 🚀 訊息彈窗 (Modal)
    // ==============================
    function showMessage(msg) {
      document.getElementById("messageText").innerText = msg;
      document.getElementById("messageBox").classList.remove("hidden");
    }
    window.showMessage = showMessage;

    document.getElementById("closeMessageBtn").addEventListener("click", () => {
      document.getElementById("messageBox").classList.add("hidden");
    });

    // ==============================
    // 🚀 建立一週 (day1~day5) 初始文件
    // ==============================
    async function populateInitialDayDocs() {
      for (let d = 1; d <= 5; d++) {
        const ref = doc(db, "public_weekly_menu", `day${d}`);
        const snap = await getDoc(ref);
        if (!snap.exists()) {
          await setDoc(ref, { 
            restaurant: "", 
            items: [] 
          });
          console.log(`建立初始 doc: day${d}`);
        }
      }
    }

    // ==============================
    // 🚀 初始化監聽菜單 (每一天)
    // ==============================
    function initializeMenuListener() {
      for (let d = 1; d <= 5; d++) {
        const ref = doc(db, "public_weekly_menu", `day${d}`);
        onSnapshot(ref, snapshot => {
          if (snapshot.exists()) {
            weeklyMenuData[d] = snapshot.data();
            renderMenuEditor();
            renderTodayMenu();
          }
        });
      }
    }

    // ==============================
    // 🚀 管理員：渲染每週菜單編輯器
    // ==============================
    function renderMenuEditor() {
      const container = document.getElementById("menuEditorArea");
      container.innerHTML = "";
      for (let d = 1; d <= 5; d++) {
        const data = weeklyMenuData[d] || { restaurant: "", items: [] };
        let html = `
          <div class="border p-3 my-2 rounded bg-white shadow">
            <h3 class="font-bold">星期${d}</h3>
            <label>餐廳名稱：
              <input class="border p-1" id="restaurant_day${d}" value="${data.restaurant}">
            </label>
            <button class="bg-blue-500 text-white px-2 py-1 rounded ml-2" onclick="updateRestaurantName(${d})">更新</button>
            <ul class="mt-2">
        `;
        data.items.forEach((item, i) => {
          html += `<li>${item.name} $${item.price}
            <button class="text-red-500" onclick="removeFood(${d}, ${i})">刪除</button>
          </li>`;
        });
        html += `</ul>
          <div class="mt-2">
            <input class="border p-1" placeholder="品項" id="item_day${d}">
            <input class="border p-1" type="number" placeholder="價格" id="price_day${d}">
            <button class="bg-green-500 text-white px-2 py-1 rounded" onclick="addFood(${d})">新增</button>
          </div>
        </div>`;
        container.innerHTML += html;
      }
    }
    window.updateRestaurantName = async function(day) {
      const ref = doc(db, "public_weekly_menu", `day${day}`);
      const name = document.getElementById(`restaurant_day${day}`).value.trim();
      await updateDoc(ref, { restaurant: name });
      showMessage(`星期${day} 餐廳更新成功`);
    };
    window.addFood = async function(day) {
      const ref = doc(db, "public_weekly_menu", `day${day}`);
      const name = document.getElementById(`item_day${day}`).value.trim();
      const price = parseInt(document.getElementById(`price_day${day}`).value);
      if (!name || isNaN(price)) return showMessage("請輸入品項與價格");
      await updateDoc(ref, { items: arrayUnion({ name, price }) });
      showMessage(`新增成功: ${name} $${price}`);
    };
    window.removeFood = async function(day, index) {
      const item = weeklyMenuData[day].items[index];
      const ref = doc(db, "public_weekly_menu", `day${day}`);
      await updateDoc(ref, { items: arrayRemove(item) });
      showMessage(`刪除 ${item.name}`);
    };

    // ==============================
    // 🚀 學生：今日菜單 + 下單
    // ==============================
    function renderTodayMenu() {
      const today = new Date().getDay(); // 0=週日, 1=週一...
      if (today < 1 || today > 5) {
        document.getElementById("todayMenuArea").innerHTML = "<p>今天沒有供餐！</p>";
        return;
      }
      const data = weeklyMenuData[today] || { restaurant: "", items: [] };
      let html = `<h3 class="font-bold">今日餐廳：${data.restaurant || "未設定"}</h3>
        <label>座號：<input id="seatNumberInput" class="border p-1 w-20"></label>
        <div>`;
      data.items.forEach((item, i) => {
        html += `
          <label>
            <input type="checkbox" id="item_${i}"> ${item.name} $${item.price}
            <input type="number" id="qty_${i}" class="border w-16" min="1" value="1">
          </label><br>`;
      });
      html += `</div>
        <button class="bg-green-500 text-white px-2 py-1 rounded mt-2" onclick="submitTodayOrder(${today})">送出訂單</button>`;
      document.getElementById("todayMenuArea").innerHTML = html;
    }
    window.submitTodayOrder = async function(day) {
      const seat = document.getElementById("seatNumberInput").value.trim();
      if (!seat) return showMessage("請輸入座號！");
      const data = weeklyMenuData[day];
      let items = [];
      let total = 0;
      data.items.forEach((item, i) => {
        if (document.getElementById(`item_${i}`).checked) {
          const qty = parseInt(document.getElementById(`qty_${i}`).value) || 1;
          items.push({ name: item.name, price: item.price, qty });
          total += item.price * qty;
        }
      });
      if (items.length === 0) return showMessage("請至少選一項餐點");
      const order = { seat, items, total, time: serverTimestamp() };
      const ref = doc(db, "public_daily_orders", new Date().toISOString().slice(0,10));
      const snap = await getDoc(ref);
      let dataObj = snap.exists() ? snap.data() : { orders: {} };
      dataObj.orders[seat] = order;
      await setDoc(ref, dataObj);
      showMessage("訂單送出成功！");
    };

    // ==============================
    // 🚀 管理員：監聽今日訂單
    // ==============================
    function initializeOrderListener() {
      const ref = doc(db, "public_daily_orders", new Date().toISOString().slice(0,10));
      onSnapshot(ref, snapshot => {
        if (snapshot.exists()) {
          todayOrders = snapshot.data().orders;
          renderOrderList();
        }
      });
    }
    function renderOrderList() {
      const container = document.getElementById("orderList");
      container.innerHTML = "";
      let total = 0, count = 0;
      Object.values(todayOrders).forEach(order => {
        container.innerHTML += `<p>座號${order.seat}: ${order.items.map(i=>`${i.name}x${i.qty}`).join(", ")} = $${order.total}</p>`;
        total += order.total;
        count++;
      });
      container.innerHTML += `<p class="font-bold">總金額：$${total} 平均：$${(total/count||0).toFixed(1)}</p>`;
    }

    // ==============================
    // 🚀 管理員登入檢查
    // ==============================
    window.checkAdminPassword = function() {
      const input = document.getElementById("adminPassword").value;
      if (input === ADMIN_PASSWORD) {
        showMessage("登入成功！");
        toggleArea("adminMenu");
      } else {
        showMessage("密碼錯誤！");
      }
    };

    // ==============================
    // 🚀 初始化
    // ==============================
    window.onload = async () => {
      await populateInitialDayDocs();
      initializeMenuListener();
      initializeOrderListener();
      renderTodayMenu();
    };
  </script>
</head>
<body class="bg-gray-100">
  <div class="p-4">
    <h1 class="text-2xl font-bold">學餐系統</h1>
    <button onclick="toggleArea('studentMenu')" class="bg-green-500 text-white px-2 py-1 m-1 rounded">學生訂餐</button>
    <button onclick="toggleArea('adminLogin')" class="bg-blue-500 text-white px-2 py-1 m-1 rounded">管理員</button>
  </div>

  <!-- 學生訂餐區 -->
  <div id="studentMenu" class="area hidden p-4">
    <h2 class="text-xl font-bold mb-2">今日菜單</h2>
    <div id="todayMenuArea"></div>
  </div>

  <!-- 管理員登入 -->
  <div id="adminLogin" class="area hidden p-4">
    <h2 class="text-xl font-bold mb-2">管理員登入</h2>
    <input type="password" id="adminPassword" class="border p-1">
    <button onclick="checkAdminPassword()" class="bg-blue-500 text-white px-2 py-1 rounded">登入</button>
  </div>

  <!-- 管理員後台 -->
  <div id="adminMenu" class="area hidden p-4">
    <h2 class="text-xl font-bold mb-2">後台管理</h2>
    <h3 class="font-bold">菜單編輯</h3>
    <div id="menuEditorArea"></div>
    <h3 class="font-bold mt-4">今日訂單</h3>
    <div id="orderList"></div>
  </div>

  <!-- 訊息 Modal -->
  <div id="messageBox" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center">
    <div class="bg-white p-4 rounded shadow">
      <p id="messageText"></p>
      <button id="closeMessageBtn" class="mt-2 bg-gray-500 text-white px-2 py-1 rounded">關閉</button>
    </div>
  </div>
</body>
</html>
